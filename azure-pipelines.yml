# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  name: Default

steps:
- script: echo Hello, world!
  displayName: 'Run a one-line script'

- script: |

    echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞:"
  displayName: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è'
  
- task: PowerShell@2
  name: notify_telegram
  displayName: "üì¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram"
  inputs:
    targetType: 'inline'
    script: |
      # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å —Å–±–æ—Ä–∫–∏
      $status = if ("$(Agent.JobStatus)" -eq "Succeeded") { "‚úÖ" } else { "‚ùå" }
      
      # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      $message = @"
      $status Pipeline: <b>$(Build.DefinitionName)</b>
      Branch: <code>$(Build.SourceBranchName)</code>
      Build: <a href='$(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)'>#$(Build.BuildNumber)</a>
      "@
      
      # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ URL (–±–µ–∑ System.Web)
      $encodedMessage = $message -replace ' ', '%20' -replace '<', '%3C' -replace '>', '%3E'
      
      # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
      $url = "https://api.telegram.org/bot7802544152:AAFej-O8UOM3dce3HG0Vc8BEx7qZA_ZdvhQ/sendMessage?chat_id=-4729697131&parse_mode=HTML&text=$encodedMessage"
      try {
        Invoke-RestMethod -Uri $url -Method Get
        Write-Host "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!"
      } catch {
        Write-Host "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: $_"
      }
  condition: always()